<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.air.tqb.mapper.base.PartInfoMapper">

    <cache-ref namespace="com.air.tqb.mapper.base.BaseMapper"/>

    <resultMap id="tmPartInfo" type="com.air.tqb.model.TmPartInfo">
        <id property="pkId" column="pk_id"/>
        <result property="idMdmPart" column="id_mdm_part"/>
        <result property="nameStandard" column="name_standard"/>
        <result property="code" column="code"/>
        <result property="name" column="name"/>
        <result property="brand" column="brand"/>
        <result property="standard" column="standard"/>
        <result property="spec" column="spec"/>
        <result property="unit" column="unit"/>
        <result property="idPartCategory" column="id_part_category"/>
        <result property="mnemonic" column="mnemonic"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="customCode" column="custom_code"/>
        <result property="shopPrice" column="shop_price"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="sellPrice" column="sell_price"/>
        <result property="defaultStore" column="default_store"/>
        <result property="oe" column="oe"/>
        <result property="safeStock" column="safe_stock"/>
        <result property="creationTime" column="creationtime"/>
        <result property="modifiedTime" column="modifiedtime"/>
        <result property="creator" column="creator"/>
        <result property="modifier" column="modifier"/>
        <result property="idOwnOrg" column="id_own_org"/>
        <result property="categoryName" column="category_name"/>
        <result property="col1" column="col1"/>
        <result property="col2" column="col2"/>
        <result property="col3" column="col3"/>
        <result property="col4" column="col4"/>
        <result property="col5" column="col5"/>
        <result property="col6" column="col6"/>
        <result property="col7" column="col7"/>
        <result property="col8" column="col8"/>
        <result property="col9" column="col9"/>
        <result property="col10" column="col10"/>
        <result property="lastPurchasePrice" column="last_purchase_price"/>
        <result property="applyModel" column="apply_model"/>
        <result property="defSeat" column="def_seat"/>
        <result property="idFrom" column="id_from"/>
        <result property="transferPrice" column="transfer_price"/>
        <result property="labelId" column="label_id"/>
        <result property="supplierId" column="supplier_id"/>
        <result property="chain" column="chain"/>
        <result property="infoId" column="info_id"/>
        <result property="storageId" column="storage_id"/>
        <result property="priceMode" column="price_mode"/>
        <result property="priceBenchmark" column="price_benchmark"/>
    </resultMap>

    <resultMap id="partInfoStockVo" type="com.air.tqb.vo.PartInfoStockVo" extends="tmPartInfo">
        <result property="stockNumber" column="stock_number"/>
        <result property="stockNumLocal" column="stock_num_local"/>
        <result property="defSeatLocal" column="def_seat_local"/>
        <result property="labelName" column="label_name"/>
        <result property="number" column="number"/>
        <result property="storageStockNumber" column="storage_stock_number"/>
        <result property="partIdLocal" column="part_id_local"/>
        <result property="outStorageStockNumber" column="out_storage_stock_number"/>
        <result property="outDefSeat" column="out_def_seat"/>
        <result property="idPurchase" column="id_purchase"/>
        <result property="priceBenchmark" column="price_benchmark"/>
        <result property="priceMode" column="price_mode"/>
        <result property="priceRate" column="price_rate"/>
    </resultMap>

    <resultMap type="com.air.tqb.vo.PartInfoCategoryVo" id="partInfoMap" extends="tmPartInfo">
        <result property="stockNumber" column="stock_number"/>
        <result property="formOrgCode" column="form_org_code"/>
        <result property="labelName" column="label_name"/>
        <result property="partIdLocal" column="part_id_local"/>
        <result property="supplierName" column="supplier_name"/>
        <result property="stockNumLocal" column="stock_num_local"/>
        <result property="defSeatLocal" column="def_seat_local"/>
        <result property="priceBenchmark" column="price_benchmark"/>
        <result property="priceMode" column="price_mode"/>
        <result property="priceRate" column="price_rate"/>
    </resultMap>


    <resultMap type="com.air.tqb.model.TmPartInfoPicture" id="pictureMap">
        <result property="partId" column="id_part"/>
        <result property="path" column="picture_src"/>
        <result property="organizationId" column="id_own_org"/>
        <result property="type" column="picture_type"/>
    </resultMap>


    <resultMap type="com.air.tqb.vo.MultipleStoreVO" id="multipleStoreMap">
        <result property="idPart" column="id_part"/>
        <result property="totalUsingNumber" column="total_using_number"/>
        <result property="stockUsingNumber" column="stock_using_number"/>
        <result property="brand" column="brand"/>
        <result property="partName" column="name"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="customCode" column="custom_code"/>
        <result property="unit" column="unit"/>
        <result property="stockNumber" column="stock_number"/>
        <result property="idPartCategory" column="id_part_category"/>
        <result property="categoryName" column="category_name"/>
        <result property="safeStock" column="safe_stock"/>
        <result property="oe" column="oe"/>
        <result property="defSeat" column="def_seat"/>
        <result property="spec" column="spec"/>
        <result property="sellPrice" column="sell_price"/>
        <result property="applyModel" column="apply_model"/>
        <result property="transferPrice" column="transfer_price"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="idOwnOrg" column="id_own_org"/>
        <result property="labelName" column="label_name"/>
        <result property="supplierName" column="supplier_name"/>
        <result property="priceRate" column="price_rate"/>
        <result property="priceMode" column="price_mode"/>
        <result property="priceBenchmark" column="price_benchmark"/>
    </resultMap>

    <resultMap type="com.air.tqb.vo.MultipleStorageVo" id="multipleStorageMap">
        <result property="idPart" column="id_part"/>
        <result property="totalUsingNumber" column="total_using_number"/>
        <result property="stockUsingNumber" column="stock_using_number"/>
        <result property="partBrand" column="brand"/>
        <result property="partName" column="name"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="customCode" column="custom_code"/>
        <result property="unit" column="unit"/>
        <result property="stockNumber" column="stock_number"/>
        <result property="idPartCategory" column="id_part_category"/>
        <result property="categoryName" column="category_name"/>
        <result property="safeStock" column="safe_stock"/>
        <result property="defSeat" column="def_seat"/>
        <result property="spec" column="spec"/>
        <result property="applyModel" column="apply_model"/>
        <result property="sellPrice" column="sell_price"/>
        <result property="transferPrice" column="transfer_price"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="idOwnOrg" column="id_own_org"/>
        <result property="labelName" column="label_name"/>
        <result property="supplierName" column="supplier_name"/>
        <result property="priceRate" column="price_rate"/>
        <result property="priceMode" column="price_mode"/>
        <result property="priceBenchmark" column="price_benchmark"/>
    </resultMap>

    <!--材料项目分类PO  -->
    <resultMap type="com.air.tqb.model.TmPartCategory" id="partCategoryMap">
        <id property="pkId" column="pk_id"/>
        <result property="name" column="name"/>
    </resultMap>

    <resultMap id="partPriceInfoVo" type="com.air.tqb.vo.PartPriceInfoVo">
        <id property="idPart" column="pk_id"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="customCode" column="custom_code"/>
        <result property="partBrand" column="brand"/>
        <result property="spec" column="spec"/>
        <result property="partName" column="name"/>
        <result property="defSeat" column="def_seat"/>
        <result property="sellPrice" column="sell_price"/>
        <result property="lastPurchasePrice" column="last_purchase_price"/>
        <result property="purchaseBillNo" column="purchase_bill_no"/>
        <result property="purchaseBillDate" column="purchase_bill_date"/>
        <result property="idPurchase" column="id_purchase"/>
        <result property="orgShortName" column="org_short_name"/>
    </resultMap>

    <resultMap id="collatePartInfoVo" type="com.air.tqb.vo.CollatePartInfoVo">
        <result property="idPart" column="id_part"/>
        <result property="partName" column="part_name"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="customCode" column="custom_code"/>
        <result property="brand" column="brand"/>
        <result property="unit" column="unit"/>
        <result property="avgPriceNoTax" column="avg_no_tax_price"/>
        <result property="stockNumber" column="stock_number"/>
        <result property="idPartCategory" column="id_part_category"/>
        <result property="storeCode" column="store_code"/>
        <result property="idOwnOrg" column="id_own_org"/>
        <result property="standard" column="standard"/>
        <result property="col1" column="col1"/>
        <result property="col2" column="col2"/>
        <result property="col3" column="col3"/>
        <result property="spec" column="spec"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="sellPrice" column="sell_price"/>
        <result property="transferPrice" column="transfer_price"/>
        <result property="defSeat" column="def_seat"/>
        <result property="applyModel" column="apply_mode"/>
        <result property="categoryName" column="category_name"/>
        <result property="chain" column="chain"/>
        <result property="supplierName" column="supplier_name"/>
        <result property="safeStock" column="safe_stock"/>
    </resultMap>

    <sql id="varSql">
        <if test="keyWord!=null and keyWord!=''">and p.name_standard like "%"#{keyWord}"%"</if>
        <if test="categoryName!=null and categoryName!=''">
            and p.category_name like "%"#{categoryName}"%"
        </if>
        <if test="name!=null and name!=''">and p.name like "%"#{name}"%"</if>
        <if test="spec!=null and spec!=''">and p.spec like "%"#{spec}"%"</if>
        <if test="supplierCode!=null and supplierCode!=''">and p.supplier_code like "%"#{supplierCode}"%"</if>
        <if test="customCode!=null and customCode!=''">and p.custom_code like "%"#{customCode}"%"</if>
        <if test="oe!=null and oe!=''">and p.oe like "%"#{oe}"%"</if>
        <if test="brand!=null and brand!=''">and p.brand like "%"#{brand}"%"</if>
        <if test="applyModel!=null and applyModel!=''">and p.apply_model like "%"#{applyModel}"%"</if>
        <if test="@Ognl@isNotEmpty(supplierName)">and sp.name like "%"#{supplierName}"%"</if>
    </sql>

    <sql id="varSqlNew">
        <if test="nameStandard!=null and nameStandard!=''">and p.name_standard like "%"#{nameStandard}"%"</if>
        <if test="categoryName!=null and categoryName!=''">
            and p.category_name = #{categoryName}
        </if>
        <if test="name!=null and name!=''">and p.name like "%"#{name}"%"</if>
        <if test="spec!=null and spec!=''">and p.spec like "%"#{spec}"%"</if>
        <if test="supplierCode!=null and supplierCode!=''">and p.supplier_code like "%"#{supplierCode}"%"</if>
        <if test="customCode!=null and customCode!=''">and p.custom_code like "%"#{customCode}"%"</if>
        <if test="oe!=null and oe!=''">and p.oe like "%"#{oe}"%"</if>
        <if test="brand!=null and brand!=''">and p.brand like "%"#{brand}"%"</if>
        <if test="applyModel!=null and applyModel!=''">and p.apply_model like "%"#{applyModel}"%"</if>
        <if test="@Ognl@isNotEmpty(supplierName)">and sp.name like "%"#{supplierName}"%"</if>
        <if test="storageId != null and @Ognl@isNotEmpty(defSeat)"> and spi.def_seat like #{defSeat}"%"</if>
        <if test="stockNum != null and stockNum == true">
            <if test="storageId != null"> and spi.stock_number > 0</if>
            <if test="storageId == null"> and s.stock_number > 0</if>
        </if>
        <if test="idMdmParts != null and idMdmParts.length > 0">
            AND p.id_mdm_part IN
            <foreach collection="idMdmParts" item="idMdmPart" open="(" close=")" separator=",">
              #{idMdmPart}
            </foreach>
        </if>
    </sql>

    <sql id="selectStoragePartInfoResult">
        <if test="isAddStock == true">
            IFNULL(s.stock_number,0)stock_number,
        </if>
        <if test="isAddStock != true">
            <if test="storageId != null">
                IFNULL(spi.def_seat,'') def_seat,IFNULL(spi.stock_number,0)stock_number,
            </if>
        </if>
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            ps.stock_number AS stock_num_local,
        </if>

    </sql>
    <sql id="selectStoragePartInfo">
        <if test="storageId != null">
            LEFT JOIN tb_storage_part_info spi on spi.storage_id = #{storageId} and spi.part_id = p.pk_id
        </if>
    </sql>



    <sql id="selectDefSeatSegment">
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            ,IFNULL(ps.def_seat, '') AS def_seat_local
        </if>
        <if test="idStorageOut != null">
            ,IFNULL(s.def_seat, '') AS def_seat
        </if>
        <if test="idStorageOut == null">
            ,IFNULL(p.def_seat, '') AS def_seat
        </if>
    </sql>
    <sql id="selectStockNumberSegment">
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            ,ps.stock_number AS stock_num_local
        </if>
        ,s.stock_number AS stock_number
    </sql>
    <sql id="selectPartIdLocalSegment">
        <if test="idStorageIn != null">
            ,ps.part_id AS part_id_local
        </if>
    </sql>
    <sql id="queryStockNumberJoinSegment">
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            LEFT JOIN view_tm_part_info p2 ON p2.info_id = p.info_id AND p2.id_own_org = CAST(#{idOwnOrgIn} as unsigned)
            AND p2.is_del = 0
            <if test="idStorageIn != null">
                LEFT JOIN tb_storage_part_info ps ON ps.part_id = p2.pk_id AND ps.storage_id = #{idStorageIn}
            </if>
            <if test="idStorageIn == null">
                LEFT JOIN tm_partinfo_stock ps ON ps.id_part = p2.pk_id
            </if>
        </if>
        <if test="idStorageOut != null">
            inner join tb_storage_part_info s on s.part_id=p.pk_id
        </if>
        <if test="idStorageOut == null">
            inner join tm_partinfo_stock s on s.id_part=p.pk_id
        </if>
    </sql>
    <sql id="queryStockNumberWhereSegment">
        <if test="idStorageOut != null">
            and s.storage_id = #{idStorageOut}
        </if>
        <if test="idOwnOrg!=null and idOwnOrg!=''">
            and s.id_own_org=CAST(#{idOwnOrg} as unsigned )
        </if>
    </sql>
    <insert id="addPartInfo" parameterType="com.air.tqb.model.TmPartInfo">
        INSERT INTO tm_part_info (pk_id, id_mdm_part, name_standard, code, name, brand, standard, spec,
        unit,id_part_category,
        mnemonic, supplier_code, custom_code, shop_price, purchase_price, sell_price, default_store, oe, safe_stock,
        id_own_org, category_name, col1, col2, col3, col4, col5, col6, col7, col8, col9, col10, is_del,
        last_purchase_price, id_from, apply_model, transfer_price, creator, creationtime, modifiedtime, label_id,
        <if test="@Ognl@isNotEmpty(supplierId)">
            supplier_id,
        </if>
        chain)
        VALUES
        (
        CAST(#{pkId} AS UNSIGNED), #{idMdmPart}, #{nameStandard}, #{code}, #{name}, #{brand}, #{standard},
        #{spec}, #{unit}, CAST(#{idPartCategory} AS UNSIGNED),
        #{mnemonic}, #{supplierCode}, #{customCode}, #{shopPrice}, #{purchasePrice},
        #{sellPrice}, #{defaultStore}, #{oe},
        #{safeStock}, CAST(#{idOwnOrg} AS UNSIGNED), #{categoryName},
        #{col1}, #{col2}, #{col3}, #{col4}, #{col5}, #{col6}, #{col7}, #{col8},
        #{col9}, #{col10}, #{isDelete}, #{lastPurchasePrice}, #{sourcePartInfoId}, #{applyModel},
        #{transferPrice}, #{creator}, now(), now(), #{labelId},
        <if test="@Ognl@isNotEmpty(supplierId)">
            CAST(#{supplierId} as unsigned),
        </if>
        #{chain}
        )
    </insert>
    <insert id="addPartInfoInBatchModel" parameterType="com.air.tqb.model.TmPartInfo">
        INSERT INTO tm_part_info (pk_id, id_mdm_part, name_standard, code, name, brand, standard, spec,
        unit,id_part_category,
        mnemonic, supplier_code, custom_code, shop_price, purchase_price, sell_price, default_store, oe, safe_stock,
        id_own_org, category_name, col1, col2, col3, col4, col5, col6, col7, col8, col9, col10, is_del,
        last_purchase_price, id_from, apply_model, transfer_price, creationtime, modifiedtime, label_id,
            supplier_id,
        chain)
        VALUES
        <foreach collection="partInfos" separator="," item="part">
        (
         CAST(#{part.pkId} as unsigned), #{part.idMdmPart}, #{part.nameStandard}, #{part.code}, #{part.name}, <if test="part.brand!=null">#{part.brand}</if><if test="part.brand==null">null</if>, #{part.standard},
            <if test="part.spec!=null">#{part.spec}</if><if test="part.spec==null">null</if>, #{part.unit}, CAST(#{part.idPartCategory} AS UNSIGNED),
        #{part.mnemonic}, #{part.supplierCode},<if test="part.customCode!=null">#{part.customCode}</if><if test="part.customCode==null">null</if>, #{part.shopPrice}, #{part.purchasePrice},
        #{part.sellPrice}, #{part.defaultStore}, #{part.oe},
        #{part.safeStock}, CAST(#{part.idOwnOrg} AS UNSIGNED), #{part.categoryName},
        #{part.col1}, #{part.col2}, #{part.col3}, #{part.col4}, #{part.col5}, #{part.col6}, #{part.col7}, #{part.col8},
        #{part.col9}, #{part.col10}, #{part.isDelete}, #{part.lastPurchasePrice}, #{part.sourcePartInfoId}, #{part.applyModel},
        #{part.transferPrice}, now(), now(), #{part.labelId},
            CAST(#{part.supplierId} as unsigned),
        #{part.chain}
        )
        </foreach>
    </insert>

    <select id="getSellPriceByCarCategoryId" resultMap="partInfoMap">
        SELECT pc.car_category_id,pc.part_id pk_id,
        <include refid="com.air.tqb.mapper.base.BaseMapper.sellPrice"/> AS sell_price,
        p.transfer_price,p.purchase_price,
        pc.price_rate,p.price_mode,p.price_benchmark,p.chain
        from  tm_part_car_category_sell_price pc
        LEFT JOIN  view_tm_part_info p on p.pk_id = pc.part_id
        WHERE p.id_own_org IN <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org"/>
        <if test="@Ognl@isNotEmpty(partIds)">
            and pc.part_id in
            <foreach collection="partIds" open="(" close=")" separator="," item="partId">
                CAST(#{partId} as unsigned)
            </foreach>
        </if>
        <if test="@Ognl@isEmpty(partIds)">
            and pc.part_id in ('')
        </if>
        <if test="carCategoryId != null">
            and pc.car_category_id = #{carCategoryId}
        </if>
    </select>
    <select id="getCountBy" resultType="INTEGER" parameterType="com.air.tqb.vo.PartInfoCategoryVo">
        select count(p.pk_id) from view_tm_part_info p
        LEFT JOIN tm_supplier sp ON sp.pk_id = p.supplier_id
        where p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and
        p.is_del=0
        <include refid="varSql"/>
    </select>
    <sql id="queryStockOutOrIn">
        <if test="stockChangedType != null and stockChangedType == 1">
            INNER JOIN (SELECT id_part,max(a.creationtime) AS creationtime FROM ts_stock_batch a
            LEFT JOIN ts_storage_stock_batch  b on a.id = b.stock_batch_id
            WHERE a.inout_type = '出库'
            <if test="storageId != null">
                and b.storage_id  = #{storageId}
            </if>

            GROUP BY id_part)t ON t.id_part = p.pk_id
        </if>
        <if test="stockChangedType != null and stockChangedType == 2">
            INNER JOIN (SELECT id_part,max(a.creationtime) AS creationtime  FROM ts_stock_batch a
            LEFT JOIN ts_storage_stock_batch  b on a.id = b.stock_batch_id
            WHERE a.inout_type = '入库'
            <if test="storageId != null">
              and b.storage_id  = #{storageId}
           </if>
            GROUP BY id_part)t ON t.id_part = p.pk_id
        </if>
        <if test="stockChangedType != null and stockChangedType == 3">
            INNER JOIN (SELECT id_part,max(a.creationtime) AS creationtime  FROM ts_stock_batch a
            LEFT JOIN ts_storage_stock_batch  b on a.id = b.stock_batch_id WHERE 1=1
            <if test="storageId != null">
                and b.storage_id  = #{storageId}
            </if>
            GROUP BY id_part)t ON t.id_part = p.pk_id
        </if>
    </sql>

    <select id="getPartInfoList" parameterType="com.air.tqb.vo.PartInfoCategoryVo" resultMap="partInfoMap">
        select p.pk_id,p.name,p.name_standard ,p.supplier_code,p.custom_code,p.brand,p.oe ,p.spec,p.unit ,p.sell_price
        ,p.id_mdm_part ,p.category_name,p.standard,p.apply_model,ifnull(p.def_seat,'') def_seat,IFNULL(o.code, o2.code)
        form_org_code,p.chain, ifnull(pl.name,'') AS label_name,p.info_id,p.supplier_id, ifnull(sp.name, '') AS
        supplier_name
        FROM
        view_tm_part_info p
        LEFT JOIN view_tm_part_info i ON p.id_from=i.pk_id
        LEFT JOIN tb_org o ON o.pk_id=i.id_own_org
        LEFT JOIN tb_org o2 ON o2.pk_id = p.id_own_org
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        LEFT JOIN tm_supplier sp ON sp.pk_id = p.supplier_id
        WHERE
        p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0
        <include refid="varSql"/>
        ORDER BY
        p.creationtime DESC,p.pk_id DESC
    </select>
    <sql id="allotStorageIn">
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            LEFT JOIN view_tm_part_info p2 ON p2.info_id = p.info_id AND p2.id_own_org = CAST(#{idOwnOrgIn} as unsigned)
            AND p2.is_del = 0
            <if test="idStorageIn != null">
                LEFT JOIN tb_storage_part_info ps
                ON ps.part_id = p2.pk_id
                AND ps.storage_id = #{idStorageIn}
            </if>
            <if test="idStorageIn == null">
                LEFT JOIN tm_partinfo_stock ps ON ps.id_part = p2.pk_id
            </if>
        </if>
    </sql>
    <select id="getPartInfoNewList" parameterType="com.air.tqb.so.PartInfoSo" resultMap="partInfoMap">
        select p.pk_id,p.name,p.name_standard ,p.supplier_code,p.custom_code,p.brand,p.oe ,p.spec,p.unit,
        <include refid="com.air.tqb.mapper.base.BaseMapper.selectSellPriceResult"/>
        <include refid="selectStoragePartInfoResult"/>
        p.id_mdm_part ,p.category_name,p.standard,p.apply_model,IFNULL(o.code, o2.code)
        form_org_code,p.safe_stock,
        p.chain,ifnull(pl.name,'') label_name,ifnull(p.last_purchase_price,p.purchase_price)
        purchase_price,
        p.transfer_price,p.id_part_category,p.label_id,p.supplier_id, ifnull(sp.name, '')
        AS supplier_name
        FROM
        view_tm_part_info p
        <include refid="com.air.tqb.mapper.base.BaseMapper.selectSellPrice"/>
        <include refid="selectStoragePartInfo"/>
        <include refid="queryStockOutOrIn"/>
        LEFT JOIN view_tm_part_info i ON p.id_from=i.pk_id
        LEFT JOIN tb_org o ON o.pk_id=i.id_own_org
        LEFT JOIN tb_org o2 ON o2.pk_id = p.id_own_org
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        LEFT JOIN tm_supplier sp ON sp.pk_id = p.supplier_id
        <include refid="allotStorageIn"/>
        <if test="isAddStock == true">
            INNER JOIN tm_partinfo_stock s ON s.id_part = p.pk_id
        </if>
        WHERE 1=1
        <if test="idOwnOrg!=null and idOwnOrg!=''">
            and p.id_own_org=CAST(#{idOwnOrg} as unsigned )
        </if>
        and p.is_del=0
        <include refid="varSqlNew"/>
        <if test="stockChangedStartDate != null">
            and t.creationtime &gt;= #{stockChangedStartDate,jdbcType=TIMESTAMP}
        </if>
        <if test="stockChangedEndDate != null">
            and t.creationtime &lt;= #{stockChangedEndDate,jdbcType=TIMESTAMP}
        </if>
        <if test="@Ognl@isNotEmpty(partIds)">
        and p.pk_id in
        <foreach collection="partIds" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
        </if>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Order_By_Clause"/>
        <if test="isPage == null or isPage == ''">
            <include refid="com.air.tqb.mapper.base.BaseMapper.Limit_By_Clause"/>
        </if>
    </select>

    <select id="getPartInfoById" parameterType="com.air.tqb.model.TmPartInfo" resultMap="partInfoMap">
        select ifnull(pl.name,'') label_name, ifnull(s.name, '') supplier_name, pi.* from view_tm_part_info pi
        LEFT JOIN tb_business_label pl ON pl.id = pi.label_id
        LEFT JOIN tm_supplier s ON s.pk_id = pi.supplier_id
        where pi.pk_id=CAST(#{pkId} as unsigned )
    </select>

    <select id="getIdFromInfoIdByIdOwnOrg" parameterType="com.air.tqb.model.TmPartInfo" resultMap="partInfoMap">
        select * from view_tm_part_info where info_id=CAST(#{infoId} as unsigned ) and id_own_org = CAST(#{idOwnOrg} as
        unsigned ) and is_del=0
    </select>

    <select id="getIdFromInfoIdByInfoId" parameterType="com.air.tqb.so.PartInfoSo" resultMap="partInfoStockVo">
        select p.pk_id,ps.stock_number,p.info_id,p.id_own_org,p.name,p.brand,
        p.standard,p.spec,p.supplier_code,p.custom_code,p.unit
        from view_tm_part_info p
        LEFT JOIN tm_partinfo_stock ps ON p.pk_id = ps.id_part
        where p.is_del=0 AND p.id_own_org IN
        <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org"/>
        and p.info_id in
        <foreach collection="infoIdList" open="(" close=")" separator="," item="infoId">
            CAST(#{infoId} as unsigned)
        </foreach>
    </select>

    <update id="editPartInfo" parameterType="com.air.tqb.model.TmPartInfo">

        UPDATE tm_part_info p
        INNER JOIN tm_part_info_detail d ON p.pk_id = d.info_id AND d.pk_id = #{pkId}
        SET
        p.id_mdm_part=#{idMdmPart},p.name_standard=#{nameStandard},p.code=#{code},p.name=#{name},p.brand=#{brand},
        p.standard=#{standard},p.spec=#{spec},p.unit=#{unit},p.id_part_category=CAST(#{idPartCategory} as unsigned),
        p.mnemonic=#{mnemonic},p.supplier_code=#{supplierCode},p.custom_code = #{customCode},
        p.shop_price=#{shopPrice},p.purchase_price=#{purchasePrice},p.sell_price=#{sellPrice},
        p.default_store=#{defaultStore},p.oe=#{oe},p.safe_stock=#{safeStock},p.modifiedtime=now(),
        p.category_name=#{categoryName},p.col1=#{col1},p.col2=#{col2},p.col3=#{col3},p.col4=#{col4},p.col5=#{col5},
        p.col6=#{col6},p.col7=#{col7},p.col8=#{col8},p.col9=#{col9},p.col10=#{col10},p.apply_model=#{applyModel},
        p.transfer_price=#{transferPrice},p.label_id=#{labelId},
        p.modifier=#{modifier},
        <if test="@Ognl@isNotEmpty(supplierId)">
            p.supplier_id = CAST(#{supplierId} as unsigned),
        </if>
        <if test="@Ognl@isEmpty(supplierId)">
            p.supplier_id = null,
        </if>
        p.chain=#{chain};
        <include refid="updateChainPrice"/>
    </update>
    <sql id="updateChainPrice">
        <if test="(chain band @com.air.tqb.model.enums.PartInfoChain@PURCHASE.value) eq @com.air.tqb.model.enums.PartInfoChain@PURCHASE.value and purchasePrice!=null">
            update tm_part_info_detail d1
            INNER JOIN tm_part_info_detail d2 ON d1.info_id = d2.info_id
            SET d1.purchase_price=#{purchasePrice}
            WHERE d2.pk_id = #{pkId};
        </if>
        <if test="(chain band @com.air.tqb.model.enums.PartInfoChain@TRANSFER.value)  eq @com.air.tqb.model.enums.PartInfoChain@TRANSFER.value and transferPrice!=null">
            update tm_part_info_detail d1
            INNER JOIN tm_part_info_detail d2 ON d1.info_id = d2.info_id
            SET d1.transfer_price=#{transferPrice}
            WHERE d2.pk_id = #{pkId};
        </if>
        <if test="(chain band @com.air.tqb.model.enums.PartInfoChain@SELL.value)  eq @com.air.tqb.model.enums.PartInfoChain@SELL.value and priceMode!=null">
            update tm_part_info_detail d1
            INNER JOIN tm_part_info_detail d2 ON d1.info_id = d2.info_id SET
                d1.price_mode=#{priceMode},
                d1.price_benchmark=#{priceBenchmark}
            WHERE d2.pk_id = #{pkId};
        </if>
    </sql>
    <!--   伪删除           -->
    <update id="deletePartInfo" parameterType="String">
        update tm_part_info_detail
        set is_del=1,modifiedtime = now()
        WHERE
        pk_id=CAST(#{pkId} as unsigned )
    </update>

    <update id="deletePartInfoByInfoIds">
        UPDATE tm_part_info_detail
        SET is_del = 1, modifiedtime = now()
        WHERE info_id IN
        <foreach collection="infoIdList" open="(" close=")" separator="," item="infoId">
            #{infoId}
        </foreach>
    </update>
    <!--   恢复伪删除           -->
    <update id="recoverDeletePartInfo" parameterType="java.util.List">
        update tm_part_info_detail
        set is_del=0,modifiedtime = now()
        WHERE pk_id in
        <foreach collection="idParts" item="idPart" open="(" separator="," close=")">
            CAST(#{idPart} as unsigned )
        </foreach>
    </update>

    <select id="getPartInfoByNameStandard" parameterType="com.air.tqb.so.PartInfoSo"
            resultMap="collatePartInfoVo">
        select p.pk_id AS id_part,p.name AS part_name,p.col1,p.col2,p.col3,p.supplier_code,p.custom_code,
        p.brand,p.unit,p.id_part_category,s.store_code,
        p.id_own_org,p.spec,p.apply_model,spi.def_seat,p.category_name,su.name AS supplier_name,spi.stock_number
        from view_tm_part_info p
        LEFT JOIN tm_supplier su ON su.pk_id = p.supplier_id
        LEFT JOIN tb_storage_part_info spi ON spi.part_id = p.pk_id AND spi.storage_id = #{storageId}
        LEFT JOIN tm_partinfo_stock s ON s.id_part = p.pk_id
        where
        p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0
        and s.id_own_org=CAST(#{idOwnOrg} as unsigned )
        <if test="nameStandard!=null and nameStandard!=''">
            and p.name_standard like "%"#{nameStandard}"%"
        </if>
        order by s.stock_number desc,p.pk_id desc
        <include refid="com.air.tqb.mapper.base.BaseMapper.Limit_By_Clause"/>
    </select>

    <select id="getPartInfoStockList" parameterType="com.air.tqb.vo.PartInfoCategoryVo" resultMap="partInfoMap">
        select p.pk_id,p.name,p.name_standard ,p.supplier_code,p.custom_code,p.brand,p.oe ,p.spec,p.unit ,p.sell_price
        ,p.id_mdm_part,p.category_name,p.standard,p.apply_model,ifnull(p.def_seat,'')
        def_seat,ifnull(p.last_purchase_price,p.purchase_price)
        purchasePrice,s.stock_number,p.id_part_category,p.chain,p.transfer_price,l.name
        AS label_name,IFNULL(o.code, o2.code)
        form_org_code
        FROM
        view_tm_part_info p
        LEFT JOIN view_tm_part_info i ON p.id_from=i.pk_id
        LEFT JOIN tb_org o ON o.pk_id=i.id_own_org
        LEFT JOIN tb_org o2 ON o2.pk_id = p.id_own_org
        LEFT JOIN tb_business_label l ON p.label_id = l.id, tm_partinfo_stock s
        WHERE p.pk_id=s.id_part and p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0
        and s.id_own_org=CAST(#{idOwnOrg} as unsigned )
        <include refid="varSql"/>
        ORDER BY
        p.creationtime DESC,p.pk_id DESC
    </select>
    <sql id="getPartInfosByBaseInfo">
        select p.pk_id,p.name,p.brand,p.spec,tps.stock_number
        from view_tm_part_info p
        LEFT JOIN tm_partinfo_stock tps ON tps.id_part = p.pk_id
        where
        p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0
        <if test="brand!=null and brand!=''">
            and p.brand = #{brand}
        </if>
        <if test="brand == null or brand == ''">
            and (p.brand is null or p.brand='')
        </if>
        and p.id_own_org = #{idOwnOrg}
        and p.name=#{name} and p.spec=#{spec}
    </sql>
    <select id="getExistPartInfos" parameterType="com.air.tqb.model.TmPartInfo" resultMap="partInfoStockVo">
        <bind name="view_id_own_org" value="@com.air.tqb.utils.WxbStatic@getOrg()"/>
         SELECT d.pk_id,TRIM(name)AS name,TRIM(brand)AS brand,TRIM(spec) AS spec,TRIM(custom_code) AS custom_code,ifnull(spi.stock_number,0) as
        stock_number,ifnull(stock.stock_number,0) as
        stock_num_local,spi.storage_id FROM tm_part_info_detail d
        INNER JOIN tb_storage_part_info spi on spi.part_id=d.pk_id
        inner join tm_partinfo_stock stock on stock.id_part=d.pk_id
        inner JOIN tm_part_info
        info on d.info_id= info.pk_id  and d.id_own_org=CAST(#{view_id_own_org} as
        unsigned ) and(
        <foreach collection=" tmPartInfos" separator=" or " item="partInfo">
            (
            name=#{partInfo.name}
            AND spi.storage_id = #{partInfo.storageId}
            <if test="@Ognl@isNotEmpty(partInfo.brand)">
               and  brand=#{partInfo.brand}
            </if>
            <if test="@Ognl@isNotEmpty(partInfo.spec)">
                and spec=#{partInfo.spec}
            </if>
            <if test="@Ognl@isNotEmpty(partInfo.customCode)">
                and custom_code=#{partInfo.customCode}
            </if>
            )
        </foreach>
        )
    </select>

    <select id="getPartInfoDropList" parameterType="com.air.tqb.model.TmPartInfo"
            resultMap="partInfoStockVo">
        select p.pk_id,p.brand,p.name,p.standard,p.spec,p.supplier_code,p.custom_code,p.unit,
        p.def_seat,ifnull(p.last_purchase_price,p.purchase_price) AS purchase_price,p.sell_price,
        s.stock_number,p.id_mdm_part,p.transfer_price,p.chain ,p.id_own_org
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            ,ps.stock_number AS stock_num_local
            ,p2.def_seat as def_seat_local
        </if>
        from view_tm_part_info p
        <if test="idOwnOrgIn != null and idOwnOrgIn != ''">
            LEFT JOIN view_tm_part_info p2 ON p2.info_id = p.info_id AND p2.id_own_org = CAST(#{idOwnOrgIn} as unsigned
            ) AND p2.is_del=0
            LEFT JOIN tm_partinfo_stock ps ON ps.id_part = p2.pk_id
        </if>
        ,tm_partinfo_stock s
        where p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0 and s.id_part=p.pk_id
        and s.id_own_org=CAST(#{idOwnOrg} as unsigned )
        <if test="nameStandard!=null and nameStandard!=''">
            and p.name_standard like "%"#{nameStandard}"%"
        </if>
        order by s.stock_number DESC,p.pk_id DESC
        <if test="number!=null">
            limit 0,#{number}
        </if>
    </select>

    <select id="getPartInfoPageIncludingPlatform" parameterType="com.air.tqb.so.PartInfoSo"
            resultMap="partInfoStockVo">
        select p.pk_id,p.brand,p.name,p.standard,p.spec,p.supplier_code,p.custom_code,p.unit,
        ifnull(p.last_purchase_price,p.purchase_price) AS purchase_price,
        <include refid="com.air.tqb.mapper.base.BaseMapper.selectSellPriceResult"/>
        p.apply_model,p.id_mdm_part,p.transfer_price,p.chain,
        p.id_own_org,ifnull(pl.name,'') label_name,p.label_id,p.supplier_id
        <include refid="selectStockNumberSegment"/>
        <include refid="selectDefSeatSegment"/>
        <include refid="selectPartIdLocalSegment"/>
        from view_tm_part_info p
        <include refid="com.air.tqb.mapper.base.BaseMapper.selectSellPrice"/>
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        <include refid="queryStockNumberJoinSegment"/>
        where p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0
        <include refid="queryStockNumberWhereSegment"/>
        <if test="nameStandard!=null and nameStandard!=''">
            and p.name_standard like "%"#{nameStandard}"%"
        </if>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Order_By_Clause"/>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Limit_By_Clause"/>
    </select>

    <select id="getPartInfoListInOrgId" resultMap="partInfoStockVo">
        SELECT p2.pk_id,p2.brand,p2.name,p2.standard,p2.supplier_code,p2.custom_code,p2.unit,p2.spec,
        p2.transfer_price,p2.def_seat,ifnull(s2.stock_number,0) AS stock_number,
        ifnull(p.safe_stock,0) AS safe_stock,p.def_seat AS def_seat_local, ifnull(s.stock_number, 0) AS stock_num_local
        FROM view_tm_part_info p
        LEFT JOIN tm_partinfo_stock s ON p.pk_id = s.id_part
        INNER JOIN view_tm_part_info p2 ON p2.info_id = p.info_id AND p.pk_id != p2.pk_id
        LEFT JOIN tm_partinfo_stock s2 ON p2.pk_id = s2.id_part
        WHERE
        p2.id_own_org = CAST(#{orgId} as unsigned )
        and p.pk_id IN
        <foreach collection="idParts" open="(" close=")" separator="," item="idPart">
            #{idPart}
        </foreach>
        and p.id_own_org in (<include
            refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org_no_symbol"/>,'9999')
    </select>

    <select id="getSafeStockPartList" resultMap="partInfoStockVo">
        select p.pk_id,p.id_mdm_part,p.brand,p.name,p.standard,p.spec,p.supplier_code,p.custom_code,
        p.unit,p.purchase_price,p.sell_price,p.supplier_id,
        p.safe_stock,s.stock_number,ifnull(p.def_seat,'') AS def_seat, p.label_id,ifnull(pl.name,'') label_name
        from view_tm_part_info p
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id ,tm_partinfo_stock s
        where p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and s.id_own_org=CAST(#{idOwnOrg} as unsigned ) and
        s.id_part=p.pk_id and p.is_del=0
        and p.safe_stock > 0 and s.stock_number &lt; p.safe_stock
        <if test="name!=null and name!=''">
            and p.name like "%"#{name}"%"
        </if>
        <if test="idPartCategory!=null and idPartCategory!=''">
            and id_part_category = CAST(#{idPartCategory} as unsigned )
        </if>
        <if test="brand!=null and brand!=''">
            and p.brand=#{brand}
        </if>
        order by p.creationtime, p.pk_id
    </select>

    <select id="getCountMdmPart" resultType="java.lang.Integer">
        select count(*) from view_tm_part_info where id_own_org=CAST(#{idOwnOrg} as unsigned ) and
        id_mdm_part = #{idMdmPart} and is_del = 0
    </select>

    <select id="getPartInfoByMdmPart" parameterType="com.air.tqb.model.TmPartInfo" resultMap="partInfoMap">
        SELECT
            p.*,
            l.name label_name
        FROM view_tm_part_info p
            LEFT JOIN tb_business_label l ON l.id = p.label_id
        WHERE p.id_own_org = CAST(#{idOwnOrg} AS UNSIGNED) AND p.id_mdm_part = #{idMdmPart} AND p.is_del = 0
        LIMIT 1
    </select>

    <!--分页查询配件材料分类信息  -->
    <sql id="partCategory">
        <if test="name!=null and name!=''">and a.name like "%"#{name}"%"</if>
    </sql>
    <select id="getPartCategoryCountBy" resultType="INTEGER" parameterType="com.air.tqb.model.TmPartCategory">
        select count(*) from tm_part_category a where a.id_own_org in (
        <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org_no_symbol"/>
        ,'9999')
        and a.p_id!=0
        <include refid="partCategory"/>
    </select>
    <select id="getPartCategoryList" parameterType="com.air.tqb.model.TmPartCategory" resultMap="partCategoryMap">
        select * from tm_part_category a where a.id_own_org in (<include
            refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org_no_symbol"/>,'9999')
        and a.p_id!=0
        <include refid="partCategory"/>
    </select>

    <select id="getMdmPartIdsByOrg" resultType="java.lang.String">
        select group_concat(id_mdm_part) id_mdm_parts from tm_part_info where id_own_org=CAST(#{idOwnOrg} as unsigned )
        and id_mdm_part != 0
    </select>

    <select id="getPartInfoByOrgId" resultMap="partInfoMap">
        SELECT *
        FROM
        view_tm_part_info as p
        WHERE
        p.id_own_org=CAST(#{idOwnOrg} as unsigned )
    </select>


    <update id="editLastPurchasePirce">
        update tm_part_info_detail set last_purchase_price = #{lastPurchasePrice} ,modifiedtime = now() where
        pk_id=CAST(#{idPart} as unsigned )
    </update>

    <update id="editPartInfoPrice" parameterType="com.air.tqb.model.TmPartInfo">

        UPDATE tm_part_info_detail
        SET
        modifier = #{modifier}
        <if test="purchasePrice!=null">
            ,purchase_price=#{purchasePrice}
        </if>
        <if test="sellPrice!=null">
            ,sell_price=#{sellPrice}
        </if>
        <if test="transferPrice!=null">
            ,transfer_price=#{transferPrice}
        </if>
        ,modifiedtime = now()
        WHERE
        pk_id=CAST(#{pkId} as unsigned );
        <include refid="updateChainPrice"/>
    </update>
    <sql id="updateChainPriceBatch">
        <if test="(part.chain band @com.air.tqb.model.enums.PartInfoChain@PURCHASE.value) eq @com.air.tqb.model.enums.PartInfoChain@PURCHASE.value and part.purchasePrice!=null and @Ognl@isNotEmpty(part.branchPartIds) ">
            update tm_part_info_detail SET purchase_price=#{part.purchasePrice} where pk_id in(
           <foreach collection="part.branchPartIds" item="id" separator=",">
              #{id}
           </foreach>
            );
        </if>
        <if test="(part.chain band @com.air.tqb.model.enums.PartInfoChain@SELL.value)  eq @com.air.tqb.model.enums.PartInfoChain@SELL.value  and @Ognl@isNotEmpty(part.branchPartIds)">
            update tm_part_info_detail
            <set>
                <if test="part.priceMode!=null">
                    price_mode=#{part.priceMode}
                </if>
                <if test="part.priceBenchmark!=null">
                    ,price_benchmark=#{part.priceBenchmark}
                </if>
                <if test="part.priceBenchmark ==null">
                    ,price_benchmark = null
                </if>
                <if test="part.sellPrice!=null">
                    ,sell_price=#{part.sellPrice}
                </if>
            </set>
            where pk_id in(
            <foreach collection="part.branchPartIds" item="id" separator=",">
                #{id}
            </foreach>
            );
        </if>
        <if test="(part.chain band @com.air.tqb.model.enums.PartInfoChain@TRANSFER.value)  eq @com.air.tqb.model.enums.PartInfoChain@TRANSFER.value and part.transferPrice!=null and @Ognl@isNotEmpty(part.branchPartIds)">
            update tm_part_info_detail SET transfer_price=#{part.transferPrice} where pk_id in(
            <foreach collection="part.branchPartIds" item="id" separator=",">
                #{id}
            </foreach>
            );
        </if>
    </sql>
    <update id="editPartInfoPriceBatch" parameterType="java.util.List">
        <if test="@Ognl@isNotEmpty(list)">
            <foreach collection="list" item="part">
          UPDATE tm_part_info_detail
                SET
                modifier = <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_current_user_id"/>
                <if test="part.purchasePrice!=null">
                    ,purchase_price=#{part.purchasePrice}
                </if>
                <if test="part.sellPrice!=null">
                    ,sell_price=#{part.sellPrice}
                </if>
                <if test="part.transferPrice!=null">
                    ,transfer_price=#{part.transferPrice}
                </if>
                <if test="part.priceBenchmark!=null">
                    ,price_benchmark=#{part.priceBenchmark}
                </if>
                <if test="part.priceMode !=null and part.priceBenchmark == null">
                    ,price_benchmark = null
                </if>
                <if test="part.priceMode!=null">
                    ,price_mode=#{part.priceMode}
                </if>
                ,modifiedtime = now()
                WHERE
                pk_id=CAST(#{part.pkId} as unsigned );
            </foreach>
        </if>

        <if test="@Ognl@isNotEmpty(list)">
        <foreach collection="list" item="part">
            <include refid="updateChainPriceBatch"/>
        </foreach>
        </if>

    </update>

    <update id="editPartInfoChain">
        UPDATE tm_part_info p
        INNER JOIN tm_part_info_detail d on d.info_id = p.pk_id AND d.pk_id = #{pkId}
        set p.chain = #{chain},p.modifiedtime = now()
    </update>
    <update id="editPartInfoChainBatch" parameterType="java.util.List">
        <if test="@Ognl@isNotEmpty(list)">
            <foreach collection="list"  item="part">
                UPDATE tm_part_info b INNER  JOIN tm_part_info_detail a on b.pk_id = a.info_id
                set b.chain = #{part.chain},b.modifiedtime = now()
                where a.pk_id=#{part.pkId};
            </foreach>
        </if>

    </update>


    <select id="validateStuff" resultType="int" parameterType="com.air.tqb.model.TmPartInfo">
        SELECT count(*)
        FROM
        view_tm_part_info as p
        WHERE
        p.id_own_org=CAST(#{idOwnOrg} as unsigned )
        and p.is_del = 0
        <if test="pkId!=null and pkId!=''">
            and pk_id != #{pkId}
        </if>
        <if test="name!=null and name!=''">
            and name = #{name}
        </if>
        <if test="brand!=null and brand!=''">
            and brand = #{brand}
        </if>
        <if test="supplierCode!=null and supplierCode!=''">
            and supplier_code = #{supplierCode}
        </if>
        <if test="spec!=null and spec!=''">
            and spec = #{spec}
        </if>
        <if test="applyModel!=null and applyModel!=''">
            and apply_model = #{applyModel}
        </if>
        <if test="customCode != null and customCode != ''">
            and custom_code = #{customCode}
        </if>
    </select>

    <insert id="addPartStockBatch">
        insert into tm_partinfo_stock(pk_id,store_code,id_part,stock_number,id_own_org,creationtime,modifiedtime)
        select uuid_short(),'CK001',pk_id,0,id_own_org,now(),now() from view_tm_part_info where id_own_org =
        CAST(#{idOwnOrg} as unsigned ) and is_del=0
    </insert>

    <select id="getPartInfoPKByInfoId" resultType="String">
        select info.pk_id from view_tm_part_info info
        WHERE info.info_id = CAST(#{infoId} as unsigned ) and info.is_del=0
    </select>

    <sql id="multipleVarSql">
        <if test="keyWord!=null and keyWord!=''">and name_standard like "%"#{keyWord}"%"</if>
        <if test="categoryName!=null and categoryName!=''">
            and category_name like "%"#{categoryName}"%"
        </if>
        <if test="spec!=null and spec!=''">and spec like "%"#{spec}"%"</if>
        <if test="supplierCode!=null and supplierCode!=''">and supplier_code like "%"#{supplierCode}"%"</if>
        <if test="customCode!=null and customCode!=''">and custom_code like "%"#{customCode}"%"</if>
        <if test="oe!=null and oe!=''">and oe like "%"#{oe}"%"</if>
        <if test="brand!=null and brand!=''">and brand like "%"#{brand}"%"</if>
        <if test="applyModel!=null and applyModel!=''">and apply_model like "%"#{applyModel}"%"</if>
        <if test="labelName!=null and labelName!=''">and pl.name like "%"#{labelName}"%"</if>
        <if test="@Ognl@isNotEmpty(supplierName)">and su.name like "%"#{supplierName}"%"</if>
        <if test="defSeat!=null and defSeat!=''">
            AND p.pk_id IN (
            SELECT DISTINCT
            part_id
            FROM
            tb_storage_part_info
            WHERE
            id_own_org = CAST(#{idOwnOrg} AS UNSIGNED)
            AND def_seat LIKE "%"#{defSeat}"%")
        </if>
    </sql>

    <sql id="getTotalStockNumber">
        FROM
        tm_partinfo_stock s
        INNER JOIN view_tm_part_info p ON p.pk_id = s.id_part
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        INNER JOIN tm_part_info_detail t ON s.id_part = t.pk_id
        LEFT JOIN tm_supplier su ON su.pk_id = p.supplier_id
        LEFT JOIN (
        SELECT
        p.id_own_org,
        p.id_part,
        IFNULL(SUM(p.stock_out_number),0) AS stockUsingNumber
        FROM
        ts_maintain t
        LEFT JOIN ts_maintain_part_detail p ON t.pk_id = p.id_maintain
        WHERE
        t.balance_status NOT IN ('7100', '7200') and
        t.id_own_org= CAST(#{idOwnOrg} as unsigned )
        GROUP BY
        p.id_part
        ) AS tp ON tp.id_part = s.id_part
        LEFT JOIN (
        (SELECT SUM(s1.stock_number) AS totalStockNumber,t1.info_id AS tid FROM tm_partinfo_stock s1,
        tm_part_info_detail t1
        WHERE s1.id_part = t1.pk_id
        AND t1.is_del = 0
        <if test="idStore==null or idStore==''">
            AND s1.id_own_org IN
            <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org"/>
            AND t1.id_own_org IN
            <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_id_own_org"/>
        </if>
        <if test="idStore!=null and idStore!=''">
            AND s1.id_own_org IN (#{idStore})
            AND t1.id_own_org IN (#{idStore})
        </if>
        GROUP BY t1.info_id) AS tt
        ) ON tt.tid =t.info_id
        where s.id_own_org= CAST(#{idOwnOrg} as unsigned ) and p.id_own_org= CAST(#{idOwnOrg} as unsigned ) and
        p.is_del = 0
        <if test="isShow==1">
            AND tt.totalStockNumber > 0
        </if>
    </sql>

    <sql id="varMultipleStoreSql">
        SELECT
        tp.stockUsingNumber stock_using_number,
        ifnull(pl.name,'') AS label_name,
        s.id_part,
        s.stock_number,
        p.name,
        p.brand,
        p.standard,
        p.supplier_code,
        p.custom_code,
        p.unit,
        p.id_part_category,
        p.category_name,
        ifnull(p.spec, '') spec,
        ifnull(p.safe_stock, 0) safe_stock,
        p.oe,
        ifnull(p.def_seat, '')
        def_seat,
        ifnull(p.apply_model, '') apply_model,
        p.sell_price,
        ifnull(p.transfer_price, 0)
        transfer_price,
        p.purchase_price,
        p.id_own_org,
        su.name AS supplierName,
        p.price_rate,
        p.price_mode,
        p.price_benchmark
    </sql>
    <select id="getMultipleStoreCountBy" resultType="INTEGER" parameterType="com.air.tqb.vo.MultipleStoreVO">
        select count(p.pk_id)
        from tm_partinfo_stock s, view_tm_part_info p
        left join tm_supplier su ON su.pk_id = p.supplier_id
        where s.id_own_org= CAST(#{idOwnOrg} as unsigned ) and p.id_own_org= CAST(#{idOwnOrg} as unsigned ) and p.pk_id
        = s.id_part and p.is_del = 0
        <include refid="multipleVarSql"/>
    </select>
    <select id="getMultipleStoreList" parameterType="com.air.tqb.vo.MultipleStoreVO" resultMap="multipleStoreMap">
        <include refid="varMultipleStoreSql"/>
        from tm_partinfo_stock s, view_tm_part_info p
        left join tm_supplier su ON su.pk_id = p.supplier_id
        where s.id_own_org= CAST(#{idOwnOrg} as unsigned ) and p.id_own_org= CAST(#{idOwnOrg} as unsigned ) and p.pk_id
        = s.id_part and p.is_del = 0
        <include refid="multipleVarSql"/>
        order by p.creationtime desc,p.pk_id DESC
    </select>

    <select id="getMultipleStoreCountByNew" resultType="INTEGER" parameterType="com.air.tqb.so.MultipleStoreSo">
        select count(p.pk_id)
        <include refid="getTotalStockNumber"/>
        <include refid="multipleVarSql"/>
    </select>

    <select id="getTmPartInfoNameList" parameterType="string" resultType="com.air.tqb.vo.PartInfoCategoryVo">
        SELECT tb.name AS labelName,tb.id as pkId
        FROM tb_business_label tb
        WHERE id_own_org = CAST(#{idOwnOrg} AS UNSIGNED) and is_del = 0
        ORDER BY tb.id
    </select>


    <select id="getMultipleStoreListNew" parameterType="com.air.tqb.so.MultipleStoreSo" resultMap="multipleStoreMap">
        <include refid="varMultipleStoreSql"/>
        <include refid="getTotalStockNumber"/>
        <include refid="multipleVarSql"/>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Order_By_Clause"/>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Limit_By_Clause"/>
    </select>

    <select id="getMultipleStorageList" parameterType="com.air.tqb.so.MultipleStorageSo" resultMap="multipleStorageMap">
        SELECT
        ifnull(pl.name,'') AS label_name,
        s.id_part,
        s.stock_number,
        p.name,
        p.brand,
        p.standard,
        p.supplier_code,
        p.custom_code,
        p.unit,
        p.id_part_category,
        p.category_name,
        ifnull(p.spec, '') spec,
        ifnull(p.safe_stock, 0) safe_stock,
        ifnull(p.apply_model, '') apply_model,
        p.sell_price,
        ifnull(p.transfer_price, 0) transfer_price,
        p.purchase_price,
        p.id_own_org,
        su.name AS supplierName,
        p.price_rate,p.price_mode,p.price_benchmark
        FROM view_tm_part_info p
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        LEFT JOIN tm_partinfo_stock s ON p.pk_id = s.id_part
        left join tm_supplier su on su.pk_id = p.supplier_id
        <if test="isShow == 1">
            INNER JOIN (SELECT SUM(info.stock_number) number,info.part_id from tb_storage st INNER JOIN tb_storage_part_info info on info.storage_id = st.id where st.id_own_org = CAST(#{idOwnOrg} as unsigned )
            and st.is_del = 0
            <if test="@Ognl@isNotEmpty(storageIdList)">
                AND  st.id IN
                <foreach item="id" index="index" collection="storageIdList" open="(" close=")"  separator=",">
                    #{id}
                </foreach>
            </if>
            GROUP BY info.part_id)a on a.part_id = p.pk_id
        </if>
        where p.id_own_org= CAST(#{idOwnOrg} as unsigned ) and p.is_del = 0
        <if test="isShow == 1">
            and a.number > 0
        </if>
        <include refid="multipleVarSql"/>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Order_By_Clause"/>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Limit_By_Clause"/>
    </select>

    <select id="getChainPart" resultType="java.lang.Integer">
        SELECT pk_id FROM view_tm_part_info WHERE pk_id IN
        <foreach collection="array" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        AND chain>0
    </select>

    <sql id="getPartsId">
        SELECT detail2.pk_id
        FROM tm_part_info_detail AS detail
        INNER JOIN tm_part_info_detail AS detail2 ON detail2.info_id = detail.info_id AND detail2.is_del = 0
        WHERE detail.pk_id = #{pkId}
    </sql>
    <select id="checkChain" resultType="java.lang.Boolean">
        SELECT (sum(count))>0
        FROM (
        SELECT count(pk_id) AS count
        FROM ta_member_card_entity AS tmce
        INNER JOIN ta_member_card_part_detail tmcpd
        ON tmce.pk_id=tmcpd.id_member_card
        AND tmcpd.id_part IN (<include refid="getPartsId"/>) AND (tmce.card_type = 'TCK' OR
        tmce.card_type='JCK') AND tmce.is_del = 0 AND
        tmce.use_type=${@com.air.tqb.model.enums.UseType@Branch.type}
        UNION
        SELECT count(pk_id) AS count
        FROM ta_member_card AS tmc
        INNER JOIN ta_member_card_part_detail tmcpd
        ON tmc.pk_id=tmcpd.id_member_card AND tmcpd.id_part IN(<include refid="getPartsId"/>)
        AND (tmc.card_type = 'TCK' OR
        tmc.card_type='JCK')
        AND
        tmc.use_type=${@com.air.tqb.model.enums.UseType@Branch.type}
        UNION
        SELECT
        count(d.pk_id) AS count
        FROM
        ts_package_part_detail d
        INNER JOIN ts_package p ON p.pk_id = d.id_package
        AND p.is_del = 0 AND
        p.use_type=${@com.air.tqb.model.enums.UseType@Branch.type}
        where id_partInfo IN(<include refid="getPartsId"/>)
        )AS temp
    </select>
    <select id="getPartInfoDropListBySo" resultMap="partInfoStockVo"
            parameterType="com.air.tqb.so.PartInfoSo">
        select
        p.pk_id,p.brand,p.name,p.standard,p.spec,p.supplier_code,p.custom_code,p.unit,
        ifnull(p.last_purchase_price,p.purchase_price) AS purchase_price,p.label_id,s.stock_number,
        <include refid="com.air.tqb.mapper.base.BaseMapper.selectSellPriceResult"/>
        <if test="storageId != null">
            spi.stock_number AS storage_stock_number,
            ifnull(spi.def_seat,'') def_seat,
        </if>
        <if test="idStorageOut != null and idStorageOut != ''">
            spt.stock_number AS out_storage_stock_number,
            ifnull(spt.def_seat,'') out_def_seat,
        </if>
        p.apply_model,p.id_mdm_part,p.transfer_price,p.chain,p.id_own_org,ifnull(pl.name,'') label_name
        from view_tm_part_info p
        <include refid="com.air.tqb.mapper.base.BaseMapper.selectSellPrice"/>
        <if test="storageId != null">
            LEFT JOIN tb_storage_part_info spi ON spi.part_id = p.pk_id AND spi.storage_id = #{storageId}
        </if>
        <if test="idStorageOut != null and idStorageOut != ''">
            LEFT JOIN tb_storage_part_info spt ON spt.part_id = p.pk_id AND spt.storage_id = #{idStorageOut}
        </if>
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        ,tm_partinfo_stock s
        where p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0 and s.id_part=p.pk_id
        and s.id_own_org=CAST(#{idOwnOrg} as unsigned )
        <if test="nameStandard!=null and nameStandard!=''">
            and p.name_standard like "%"#{nameStandard}"%"
        </if>
        <if test="chain!=null and chain!=''">
            and p.chain =#{chain}
        </if>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Order_By_Clause"/>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Limit_By_Clause"/>
    </select>
    <select id="getPartPriceInfo" parameterType="string" resultMap="partPriceInfoVo">
        select pi.pk_id,pi.supplier_code,pi.custom_code,pi.brand,pi.name,pi.spec,pi.def_seat,pi.sell_price,
        t.pk_id id_purchase,t.bill_no purchase_bill_no,pi.last_purchase_price,pi.price_rate,pi.price_mode,pi.price_benchmark,
        date_format(t.bill_Date,'%Y-%m-%d') purchase_bill_date,o.abbreviation org_short_name
        from view_tm_part_info pi
        LEFT JOIN ts_purchase_detail p ON pi.pk_id = p.id_part
        LEFT JOIN ts_purchase t ON p.id_purchase = t.pk_id
        AND t.bill_status = 6200
        AND t.id_own_org IN
        <include refid="com.air.tqb.mapper.base.BaseMapper.c_select_with_permission_ids_own_org"/>
        INNER JOIN tb_org o ON o.pk_id = pi.id_own_org
        where
        pi.pk_id = #{idPart}
        order by t.creationtime desc
        limit 0,1
    </select>
    <select id="getPartInfoByPurchaseIds" parameterType="com.air.tqb.so.PartInfoSo" resultMap="partInfoStockVo">
        select
        p.pk_id,p.brand,p.name,p.standard,p.spec,p.supplier_code,p.custom_code,p.unit,
        ifnull(p.last_purchase_price,p.purchase_price) AS purchase_price,
        p.apply_model,p.id_mdm_part,p.transfer_price,p.chain,p.id_own_org,
        ifnull(pl.name,'') label_name,d.number,d.id_purchase
        <include refid="selectStockNumberSegment"/>
        <include refid="selectDefSeatSegment"/>
        <include refid="selectPartIdLocalSegment"/>
        from ts_purchase_detail d
        LEFT JOIN view_tm_part_info p ON p.pk_id = d.id_part
        LEFT JOIN tb_business_label pl ON pl.id = p.label_id
        <include refid="queryStockNumberJoinSegment"/>
        where p.id_own_org=CAST(#{idOwnOrg} as unsigned ) and p.is_del=0
        <include refid="queryStockNumberWhereSegment"/>
        and d.id_purchase in
        <foreach item="idPurchases" collection="idPurchases" open="(" separator="," close=")">
            CAST(#{idPurchases} as unsigned )
        </foreach>
        <include refid="com.air.tqb.mapper.base.BaseMapper.Order_By_Clause"/>
    </select>
    <select id="getPartInfoByIdAndStorageId" resultMap="collatePartInfoVo">
        SELECT tsp.def_seat,ts.`name` supplier_name,info.pk_id id_part
        from tb_storage_part_info tsp
        LEFT JOIN view_tm_part_info info on info.pk_id = tsp.part_id
        LEFT JOIN tm_supplier ts on ts.pk_id = info.supplier_id
        WHERE
        <foreach collection="list" item="partInfo" separator="or">
            (storage_id = #{partInfo.storageId} and part_id = #{partInfo.idPart})
        </foreach>

    </select>
    <!--/***********************************库存5.0 - 新增sql *************************************/-->
    <sql id="varViewSql">
        <if test="nameStandard!=null and nameStandard!=''">and p.name_standard like "%"#{nameStandard}"%"</if>
        <if test="categoryName!=null and categoryName!=''">
            and p.category_name = #{categoryName}
        </if>
        <if test="name!=null and name!=''">and p.name like "%"#{name}"%"</if>
        <if test="spec!=null and spec!=''">and p.spec like "%"#{spec}"%"</if>
        <if test="supplierCode!=null and supplierCode!=''">and p.supplier_code like "%"#{supplierCode}"%"</if>
        <if test="customCode!=null and customCode!=''">and p.custom_code like "%"#{customCode}"%"</if>
        <if test="oe!=null and oe!=''">and p.oe like "%"#{oe}"%"</if>
        <if test="brand!=null and brand!=''">and p.brand like "%"#{brand}"%"</if>
        <if test="applyModel!=null and applyModel!=''">and p.apply_model like "%"#{applyModel}"%"</if>
        <if test="@Ognl@isNotEmpty(supplierName)">and sp.name like "%"#{supplierName}"%"</if>
        <if test="storageId != null and @Ognl@isNotEmpty(defSeat)"> and spi.def_seat like #{defSeat}"%"</if>
        <if test="stockNum != null and stockNum == true">
            <if test="storageId != null"> and spi.stock_number > 0</if>
            <if test="storageId == null"> and s.stock_number > 0</if>
        </if>
        <if test="idMdmParts != null and idMdmParts.length > 0">
            AND p.id_mdm_part IN
            <foreach collection="idMdmParts" item="idMdmPart" open="(" close=")" separator=",">
                #{idMdmPart}
            </foreach>
        </if>
        <if test="@Ognl@isNotEmpty(partIds)">
            AND p.pk_id IN
            <foreach item="id" index="index" collection="partIds" open="(" close=")"  separator=",">
                CAST(#{id}  as unsigned )
            </foreach>
        </if>
    </sql>
    <sql id="varViewSelect">
        SELECT
          	p.`id_mdm_part` AS `id_mdm_part`,
            p.`name_standard` AS `name_standard`,
            p.`code` AS `code`,
            p.`name` AS `name`,
            p.`supplier_code` AS `supplier_code`,
            p.`custom_code` AS `custom_code`,
            p.`brand` AS `brand`,
            p.`spec` AS `spec`,
            p.`standard` AS `standard`,
            p.`unit` AS `unit`,
            p.`id_part_category` AS `id_part_category`,
            p.`category_name` AS `category_name`,
            p.`mnemonic` AS `mnemonic`,
            p.`oe` AS `oe`,
            p.`col1` AS `col1`,
            p.`col2` AS `col2`,
            p.`col3` AS `col3`,
            p.`col4` AS `col4`,
            p.`col5` AS `col5`,
            p.`col6` AS `col6`,
            p.`col7` AS `col7`,
            p.`col8` AS `col8`,
            p.`col9` AS `col9`,
            p.`col10` AS `col10`,
            p.`apply_model` AS `apply_model`,
            p.`id_from` AS `id_from`,
            p.`label_id` AS `label_id`,
            p.`supplier_id` AS `supplier_id`,
            p.`chain` AS `chain`,
            p.`pk_id` AS `pk_id`,
            p.`modifiedtime` AS `modifiedtime`,
            p.`creationtime` AS `creationtime`,
            p.`is_del` AS `is_del`,
            p.`modifier` AS `modifier`,
            p.`creator` AS `creator`,
            p.`transfer_price` AS `transfer_price`,
            p.`last_purchase_price` AS `last_purchase_price`,
            p.`purchase_price` AS `purchase_price`,
            p.`shop_price` AS `shop_price`,
            p.`id_own_org` AS `id_own_org`,
            p.`info_id` AS `info_id`,
            p.`price_mode` AS `price_mode`,
            p.`price_benchmark` AS `price_benchmark`,
            p.`safe_stock` AS `safe_stock`,
           ifnull(tbl.name,'') AS label_name
    </sql>
    <select id="getViewPartInfo" resultMap="partInfoMap">
        <include refid="varViewSelect"/>
         from view_part_info p
         LEFT JOIN tb_business_label tbl ON tbl.id = p.label_id
         WHERE 1=1
        <include refid="varViewSql"/>
    </select>
</mapper>

